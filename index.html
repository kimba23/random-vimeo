<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Random Vimeo â€” Victor</title>
  <style>
    :root { --bg:#0b0b0b; --fg:#f1f1f1; --accent:#6a5acd; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Arial,sans-serif}
    .wrap{max-width:1300px;margin:28px auto;padding:16px}
    .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .title{margin:0;font-weight:700}
    button{border:0;padding:10px 14px;border-radius:12px;cursor:pointer;background:var(--accent);color:#fff}
    .comment{opacity:.9;margin-top:6px;font-style:italic}
    .hero{margin-top:14px}
    /* HAZLO GRANDE: 1920x1080 ratio y ancho completo */
    .hero iframe{width:100%;aspect-ratio:16/9;border:0;border-radius:16px;background:#000}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
    .card{background:#111;border:1px solid #1d1d1d;border-radius:12px;padding:8px}
    .card iframe{width:100%;aspect-ratio:16/9;border:0;border-radius:8px;background:#000}
    .meta{margin-top:6px;font-size:.9rem;opacity:.85}
    @media (max-width:1150px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:900px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:580px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1 class="title">ðŸŽ² Random Vimeo</h1>
      <button id="btn-refresh">Otro random (5)</button>
      <button id="btn-shuffle">Shuffle</button>
    </div>
    <div id="chiruli" class="comment">ChirulÃ­ dice: cargando cositas sabrosonasâ€¦</div>

    <!-- HÃ©roe grande -->
    <div id="hero" class="hero">
      <div style="padding:28px;border:1px dashed #333;border-radius:16px;">Cargando videosâ€¦</div>
    </div>
    <div id="hero-title" class="meta"></div>

    <!-- Cuatro mÃ¡s abajo -->
    <div id="grid" class="grid"></div>
  </div>

  <script>
    const API = '/api/vimeo-videos';

    const QUOTES = [
      "ChirulÃ­ dice: si suena, rueda; si vibra, queda.",
      "ChirulÃ­ dice: arte toâ€™ los dÃ­as, con tumbao y sin permiso.",
      "ChirulÃ­ dice: random es destino disfrazado.",
      "ChirulÃ­ dice: dale play sin miedo, que lo demÃ¡s es cuento.",
      "ChirulÃ­ dice: si te guiÃ±a el ojo, es paâ€™ verlo dos veces."
    ];

    const heroEl = document.getElementById('hero');
    const heroTitle = document.getElementById('hero-title');
    const gridEl = document.getElementById('grid');
    const chiruliEl = document.getElementById('chiruli');

    let VIDEOS = [];

    function chiruliComment(extra){
      const base = QUOTES[Math.floor(Math.random()*QUOTES.length)];
      chiruliEl.textContent = extra ? `${base} â€” ${extra}` : base;
    }

    function vimeoSrc(id, opts={}){
      const p = new URLSearchParams({
        autoplay: opts.autoplay ? 1 : 0,
        muted: opts.muted ? 1 : 0,
        title: 0, byline: 0, portrait: 0,
        autopause: 0, playsinline: 1, dnt: 1
      });
      return `https://player.vimeo.com/video/${id}?${p.toString()}`;
    }

    function uniqueSample(arr,n){
      const copy = arr.slice();
      for(let i=copy.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [copy[i],copy[j]]=[copy[j],copy[i]]; }
      return copy.slice(0, Math.min(n, copy.length));
    }

    function renderFive(){
      if(!VIDEOS.length) return;
      const picks = uniqueSample(VIDEOS,5);
      const [main,...rest] = picks;

      heroEl.innerHTML = `
        <iframe
          src="${vimeoSrc(main.id,{autoplay:1, muted:1})}"
          allow="autoplay; fullscreen; picture-in-picture"
          allowfullscreen
          loading="eager"
        ></iframe>`;
      heroTitle.textContent = main.name || '';

      gridEl.innerHTML = '';
      rest.forEach(v=>{
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML=`
          <iframe
            src="${vimeoSrc(v.id,{autoplay:0, muted:0})}"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
            loading="lazy"
          ></iframe>
          <div class="meta">${v.name || 'Sin tÃ­tulo'}</div>`;
        card.addEventListener('click', ()=>{
          heroEl.querySelector('iframe').src = vimeoSrc(v.id,{autoplay:1, muted:1});
          heroTitle.textContent = v.name || '';
          chiruliComment('cambiaste la corona.');
        });
        gridEl.appendChild(card);
      });

      chiruliComment('cinco al hilo.');
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      return arr;
    }

    async function load(){
      try{
        const r = await fetch(API,{cache:'no-store'});
        const data = await r.json();
        VIDEOS = (data.items||[]).filter(v=>v?.id);
        if(!VIDEOS.length){
          heroEl.innerHTML = `<div style="padding:28px;border:1px dashed #333;border-radius:16px;">
            No llegaron videos. Revisa Ã¡lbum/usuario y permisos de embed en Vimeo.
          </div>`;
          return;
        }
        renderFive();
      }catch(e){
        heroEl.innerHTML = `<div style="padding:28px;border:1px dashed #333;border-radius:16px;">
          Error cargando: ${e?.message || e}
        </div>`;
      }
    }

    document.getElementById('btn-refresh').onclick = renderFive;
    document.getElementById('btn-shuffle').onclick = ()=>{ shuffle(VIDEOS); renderFive(); chiruliComment('barajita nueva.'); };

    load();
  </script>
</body>
</html>
